#!/bin/bash
# üîó AI-Bridge Unified CLI Interface
# Single command for all bridge operations

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BRIDGE_REGISTRY="$SCRIPT_DIR/ai-bridge-old"
SEND_TO_PEER="$SCRIPT_DIR/send-to-peer.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m'

show_help() {
    echo -e "${BLUE}üîó AI-Bridge Unified CLI${NC}"
    echo "================================================"
    echo ""
    echo "USAGE:"
    echo "    ai-bridge <command> [arguments]"
    echo ""
    echo "COMMANDS:"
    echo "    connect <team1> <team2> \"<context>\"    Create bridge between teams"
    echo "    send <target-team> \"<message>\"         Send message to team"
    echo "    list                                     List all active bridges"
    echo "    status <team>                           Show team's bridges"  
    echo "    cleanup [--dry-run]                     Clean up old bridges"
    echo "    help                                    Show this help"
    echo ""
    echo "EXAMPLES:"
    echo "    ai-bridge connect frontend backend \"API coordination\""
    echo "    ai-bridge send backend \"Database schema updated\""
    echo "    ai-bridge list"
    echo "    ai-bridge status frontend"
    echo "    ai-bridge cleanup --dry-run"
    echo ""
}

if [ $# -eq 0 ] || [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    "connect"|"create")
        if [ $# -lt 3 ]; then
            echo -e "${RED}‚ùå Error: Missing arguments${NC}"
            echo "Usage: ai-bridge connect <team1> <team2> \"<context>\""
            exit 1
        fi
        
        TEAM1="$1"
        TEAM2="$2" 
        CONTEXT="$3"
        
        echo -e "${BLUE}üîó Creating bridge: $TEAM1 ‚Üî $TEAM2${NC}"
        python3 "$BRIDGE_REGISTRY" create "$TEAM1" "$TEAM2" "$CONTEXT"
        ;;
        
    "send"|"message")
        if [ $# -lt 2 ]; then
            echo -e "${RED}‚ùå Error: Missing arguments${NC}"
            echo "Usage: ai-bridge send <target-team> \"<message>\""
            exit 1
        fi
        
        TARGET="$1"
        MESSAGE="$2"
        
        echo -e "${BLUE}üì§ Sending message to $TARGET${NC}"
        "$SEND_TO_PEER" "$TARGET" "$MESSAGE"
        ;;
        
    "list"|"ls")
        echo -e "${BLUE}üìã Active Bridges${NC}"
        python3 "$BRIDGE_REGISTRY" list
        ;;
        
    "status"|"info")
        if [ $# -lt 1 ]; then
            echo -e "${RED}‚ùå Error: Missing team name${NC}"
            echo "Usage: ai-bridge status <team>"
            exit 1
        fi
        
        TEAM="$1"
        echo -e "${BLUE}üìç Bridge status for $TEAM${NC}"
        python3 "$BRIDGE_REGISTRY" status "$TEAM"
        ;;
        
    "cleanup"|"clean")
        echo -e "${BLUE}üßπ Bridge cleanup${NC}"
        python3 "$BRIDGE_REGISTRY" cleanup "$@"
        ;;
        
    *)
        echo -e "${RED}‚ùå Unknown command: '$COMMAND'${NC}"
        echo ""
        echo -e "${YELLOW}üí° Available commands:${NC}"
        echo "   connect, send, list, status, cleanup, help"
        echo ""
        echo -e "${YELLOW}üí° Try:${NC} ai-bridge help"
        exit 1
        ;;
esac